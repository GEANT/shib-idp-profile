<?xml version="1.0" encoding="UTF-8"?>
<!-- See LICENSE.txt file in the root directory of this repository for the 
    copyright/license information. -->
<flow xmlns="http://www.springframework.org/schema/webflow"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow.xsd"
          parent="intercept.abstract">

        <!-- Rudimentary impediment to direct execution of subflow. -->
        <input name="calledAsSubflow" type="boolean" required="true" />

        <action-state id="SetEvent">
           <evaluate expression="InitializeUserProfileCacheContext" />
           <evaluate expression="UpdateLoginEvents" />
           <evaluate expression="UpdateConnectedOrganizations" />     
           <evaluate expression="StoreToken" />
           <evaluate expression="CommitUserProfileEvents" />        
           <evaluate expression="flowRequestContext.getActiveFlow().getApplicationContext().containsBean('userProfile.setEventsFunction') ? flowRequestContext.getActiveFlow().getApplicationContext().getBean('userProfile.setEventsFunction').apply(opensamlProfileRequestContext):'proceed'" />
           <evaluate expression="'proceed'" />
           <transition on="proceed" to="proceed" />
        </action-state>

        <bean-import resource="user-profile-beans.xml" />

</flow>