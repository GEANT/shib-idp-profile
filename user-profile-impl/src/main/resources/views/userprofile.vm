##
## Velocity Template for userprofile (for now as end state)
##
## Velocity context will contain the following variables during controlled errors.
## Some error paths involve runtime exceptions handled outside Spring Web Flow by the
## MVC layer and will not generally populate most of these variables.
##
## flowRequestContext - the Spring Web Flow RequestContext
## profileRequestContext - root of context tree
## encoder - HTMLEncoder class
## environment - Spring Environment object for property resolution
## userProfileContext - user profile context
## attributeDisplayNameFunction - function to display attribute name
##
##
#set ($userAttributes = $userProfileContext.getIdPUserAttributes())
#set ($record = $userProfileContext.getRecord())
#set ($pastLogins = $record.get("RELYING_PARTY"))
#set ($relyingParties = $userProfileContext.getRelyingParties())
#set ($encodedJSONAttributes = $userProfileContext.getRPEncodedJSONAttributes())
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
        <link rel="stylesheet" type="text/css" href="/css/userprofile.css")">
    </head>
    <body>
        <main class="main">
            <header>
                <img class="main-logo" src="$request.getContextPath()#springMessageText("idp.logo", "/images/placeholder-logo.png")" alt="#springMessageText("idp.logo.alt-text", "logo")" />
                <h1>#springMessageText("idp.userprofile.pageheading", "User Profile Page")</h1>
            </header>
            <section>
                <h1>#springMessageText("idp.userprofile.personaldata.heading", "Personal Data")</h1>
                <table>
                  #foreach($attribute in $userAttributes)
                  <tr>
                    <td>$encoder.encodeForHTMLAttribute($attributeDisplayNameFunction.apply($attribute))</td>
                    <td>
                    #foreach ($value in $attribute.values)
                      <p>$encoder.encodeForHTMLAttribute($value.getDisplayValue())</p>
                    #end
                    </td>
                  </tr>
                  #end
                </table>
            </section>
            <section>
                <h1>#springMessageText("idp.userprofile.connectedorganizations.heading", "Connected organizations")</h1>
            </section>
            <section>
                <h1>#springMessageText("idp.userprofile.allactivity.heading", "All activity")</h1>
                <table>
                  <tr>
                    <th>Time</th>
                    <th>Service</th>
                  </tr>
                  #foreach($item in $pastLogins)
                  <tr>
                    <td>$encoder.encodeForHTMLAttribute($item.iat)</td>
                    <td>$encoder.encodeForHTMLAttribute($relyingParties["$item.value"].name)</td>
                  </tr>
                  #end
                </table>
            </section>
            <section>
                <form action="$flowExecutionUrl" method="post">
                  #parse("csrf/csrf.vm")
                  <h1>#springMessageText("idp.userprofile.availableorganizations.heading", "Available Organizations")</h1>
                  <table>
                    #foreach($rpId in $relyingParties.keySet())
                    <tr>
                      <td>$encoder.encodeForHTMLAttribute($relyingParties[$rpId].name)</td>
                      <td>
                      #if ($encodedJSONAttributes.containsKey($rpId))
                      <table>
                        #set ($rpEncodedJSONAttributes = $encodedJSONAttributes[$rpId])
                        #foreach($attribute in $rpEncodedJSONAttributes.keySet())
                        <tr>
                          <td>$encoder.encodeForHTMLAttribute($attributeDisplayNameFunction.apply($attribute))</td>
                          <td>
                          #foreach ($value in $attribute.values)
                            <p>$encoder.encodeForHTMLAttribute($value.getDisplayValue())</p>
                          #end
                          </td>
                        </tr>
                        #end
                      </table>
                      #else
                      <button type="submit" name="_eventId_showAttributes" value="$encoder.encodeForHTMLAttribute($rpId)" onClick="this.childNodes[0].nodeValue='#springMessageText("idp.userprofile.resolving", "Resolving attributes, please wait...")'">#springMessageText("idp.userprofile.showattributes", "Information to be Provided to Service")</button>
                      #end
                      </td>
                    </tr>
                  #end
                  </table>
                </form>
            </section>
        </main>
        <footer class="footer">
            <div class="cc">
                <p>#springMessageText("idp.footer", "Insert your footer text here.")</p>
            </div>
        </footer>
    </body>
</html>